parse_check_results <- function(path) {
  lines <- paste(readLines(path), collapse = "\n")

  # Strip off trailing NOTE and WARNING messages
  lines <- gsub("^NOTE: There was .*\n$", "", lines)
  lines <- gsub("^WARNING: There was .*\n$", "", lines)

  pieces <- strsplit(lines, "\n\\* ")[[1]]

  structure(
    list(
      errors =   pieces[grepl("... ERROR", pieces, fixed = TRUE)],
      warnings = pieces[grepl("... WARN", pieces, fixed = TRUE)],
      notes =    pieces[grepl("... NOTE", pieces, fixed = TRUE)]
    ),
    path = path,
    class = "check_results"
  )
}

signal_check_results <- function(x, on = c("none", "error", "warning", "note")) {
  has <- lapply(x, function(x) length(x) > 0)

  on <- match.arg(on)
  has_problem <- switch(on,
    none  =   FALSE,
    error =   has$errors,
    warning = has$errors | has$warnings,
    note =    has$errors | has$warnings | has$notes
  )

  if (has_problem) {
    stop(summarise_check_results(x), call. = FALSE)
  }
  invisible(TRUE)
}

#' @export
print.check_results <- function(x, ...) {
  message("R CMD check results")
  message(summarise_check_results(x))

  cat(format(x), "\n", sep = "")
  invisible(x)
}

#' @export
format.check_results <- function(x, ...) {
  paste0(unlist(x), collapse = "\n\n")
}

summarise_check_results <- function(x) {
  n <- lapply(x, length)
  paste0(
    n$errors, " ", ngettext(n$errors, "error ", "errors"), " | ",
    n$warnings, " ", ngettext(n$warnings, "warning ", "warnings"), " | ",
    n$notes, " ", ngettext(n$notes, "note ", "notes")
  )
}

#' Parses R CMD check log file for ERRORs, WARNINGs and NOTEs
#'
#' Extracts check messages from the \code{00check.log} file generated by
#' \code{R CMD check}.
#'
#' @param path check path, e.g., value of the \code{check_dir} argument in a
#'   call to \code{\link{check}}
#' @param error,warning,note logical, indicates if errors, warnings and/or
#'   notes should be returned
#' @return a character vector with the relevant messages, can have length zero
#'   if no messages are found
#'
#' @seealso \code{\link{check}}, \code{\link{revdep_check}}
#' @export
check_failures <- function(path, error = TRUE, warning = TRUE, note = TRUE) {
  check_dir <- file.path(path, "00check.log")

  results <- parse_check_results(check_dir)

  c(
    if (error) results$errors,
    if (warning) results$warnings,
    if (note) results$notes
  )
}
